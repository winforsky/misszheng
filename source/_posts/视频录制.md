---
title: 视频录制
comments: false
date: 2019-01-14 15:13:54
tags:
categories:
---
## 私有权限
私有权限要求添加以下描述：
```
NSCameraUsageDescription
NSMicrophoneUsageDescription
NSPhotoLibraryAddUsageDescription
```
如果没有添加会crash。

## 录制视频
录制视频可以有三种方法：
```
1)UIImagePickerController
2)AVCaptureSession + AVCaptureMovieFileOutput
3)AVCaptureSession + AVAssetWriter
```
<!--more-->
### UIImagePickerController
* 优点：使用起来最简单的
* 缺点：可定制化也是最低的，只能设置一些简单的参数来实现基本的视频录制的效果。
* 如果你想自定义录制界面的UI，那这个简单方法可能就不大适合。
* 自定义 UI的实现方法
隐藏默认控件，然后创建带有控件的自定义视图，并覆盖在相机预览图层上面
```
UIView *cameraOverlay = …
picker.showsCameraControls = NO;
picker.cameraOverlayView = cameraOverlay;
```
注意：需要将覆盖层上的控件关联上 UIImagePickerController 的控制方法 (比如，startVideoCapture 和 stopVideoCapture)。

###  2)AVCaptureSession + AVCaptureMovieFileOutput
###  3)AVCaptureSession + AVAssetWriter
* 优点：可定制化程度高
* 缺点：两种方式都要使用AVFoundation框架，可配置项比较多，操作稍微复制点。
* 主要类：
AVCaptureSession，负责调配输入和输出，算是总的管理，使用一个 capture session，需要先实例化，添加输入与输出，接着启动从输入到输出之间的数据流

AVCaptureDeviceInput，定制视频的输入

AVCaptureMovieFileOutput， 捕获的视频文件输出

AVCaptureVideoDataOutput， 捕获的视频raw data输出

AVCaptureAudioDataOutput， 捕获的音频raw data输出

AVAssetWriter，负责输出保存为视频

* 视频输入：

  ![参见图片](https://objccn.io/images/issues/issue-23/AVCaptureSession.svg)

* 视频输出：

  ![参见图片](https://objccn.io/images/issues/issue-23/AVAssetWriter.svg)

* 更细节的地方参见：
[在 iOS 上捕获视频](https://objccn.io/issue-23-1/)

### 使用注意事项
* 权限验证
    ```
    (AVAuthorizationStatus)authorizationStatusForMediaType:(AVMediaType)mediaType;
    ```

    以下摘自iOS的开发文档
    ```
    Recording audio or video always requires explicit permission from the user. The first time you create any AVCaptureDeviceInput objects for a media type that requires permission, the system automatically displays an alert to request recording permission.
    录制音频或视频时需求得到用户的允许确认。当你第一次创建AVCaptureDeviceInput相关的对象时，系统会自动弹窗请求权限的确认。

    After the user grants recording permission, the system remembers the choice for future use in the same app, but the user can change this choice at any time using the Settings app. If the user has denied your app recoding permission or has not yet responded to the permission prompt, any audio recordings will contain only silence and any video recordings will contain only black frames.
    当用户授权之后，系统会自动记住用户的选择，但是用户可以在任何时候到设置中进行修改。如果用户拒绝或没有响应权限的许可时，音视频录制时没有声音，且只有黑色的画面。

    If this method returns AVAuthorizationStatusNotDetermined, you can call requestAccessForMediaType:completionHandler: to prompt the user for recording permission.
    如果这个方法返回`AVAuthorizationStatusNotDetermined`时，你可以使用`requestAccessForMediaType:completionHandler: `再次获取用户的授权

    Calling this method with any media type other than AVMediaTypeVideo or AVMediaTypeAudio raises an exception.
    使用这个方法时的参数只能是`AVMediaTypeVideo` 或 `AVMediaTypeAudio`，其他会导致异常。
    ```

* 检查设备是否支持相机录制
    ```
    if ([UIImagePickerController
        isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
        NSArray *availableMediaTypes = [UIImagePickerController
        availableMediaTypesForSourceType:UIImagePickerControllerSourceTypeCamera];
        if ([availableMediaTypes containsObject:(NSString *)kUTTypeMovie]) {
            // 支持视频录制
        }
    }
    ```

* 确认想要设置的相机是可用
    ```
    UIImagePickerController *camera = …
    if ([UIImagePickerController isCameraDeviceAvailable:UIImagePickerControllerCameraDeviceFront]) {
        [camera setCameraDevice:UIImagePickerControllerCameraDeviceFront];
    }
    ```

* 实时预览
使用 AVFoundation 来做图像捕获时必须提供一套自定义的用户界面，其中一个关键的相机交互组件是实时预览图。

    最简单的实现方式是通过把 AVCaptureVideoPreviewLayer 对象作为一个 sublayer 加到相机图层上去：

    ```
    AVCaptureSession *captureSession = ...;
    AVCaptureVideoPreviewLayer *previewLayer = [AVCaptureVideoPreviewLayer layerWithSession:captureSession];
    UIView *cameraView = ...;
    previewLayer.frame = cameraView.bounds;
    [cameraView.layer addSublayer:previewLayer];
    ```

## 更多
* [最简单的基于FFmpeg的移动端例子：IOS HelloWorld](https://blog.csdn.net/leixiaohua1020/article/details/47071547)
* [视音频数据处理入门：H.264视频码流解析](https://blog.csdn.net/leixiaohua1020/article/details/50534369)
* [仿微信小视屏 iOS 技术路线实践笔记](https://github.com/Damonvvong/DevNotes/blob/master/Notes/videorecoder.md)